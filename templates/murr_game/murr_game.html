{% extends 'base.html' %}
{% load static %}

{% block css %}
    {{ block.super }}
    <style>
        body {
            background-color: transparent;
        }

        img {
            max-width: 100%;
        }

        .log_panel {
            background-color: rebeccapurple;
            border-radius: 5px;
            padding: 3px;
            overflow: auto;
            max-height: 175px;

        }

        .log_panel_message {
            color: #1b1e21;
            background-color: floralwhite;
            border-radius: 5px;
            margin-bottom: 1px;
            padding-left: 5px;
            padding-bottom: 1px;
            font-size: 12px;

        }

        .active_panel {
            border: 1px solid #dee2e6;
        }

        .murren_card {
            color: #1d2124;
            background-color: whitesmoke;
            border-radius: 5px;
            font-size: 13px;
            padding: 5px;
        }

    </style>
{% endblock css %}

{% block content %}
    <div class="row mx-1 ">

        <div id="panel" class="col-2 pt-3 bg-primary">
            {% include 'murr_game/panel.html' %}
        </div>


        <div class="col-10 bg-success p-0">
            {% include 'murr_game/monitor.html' %}
        </div>

    </div>

{% endblock content %}

{% block js %}
    {{ block.super }}
    <script>
        new Vue({
            el: '#monitor',
            delimiters: ['[[', ']]'],

            data: {

                {# switchers and logs#}
                show_tawern: false,
                show_create_group: false,
                success_group_created: false,

                logs: ['Действие: включен логер', 'Действие: Ты вошел в murr',],


                group_name_input: '',
                name: 'Murr',


                murren_name: '',
                avatar_url: '',
                hp: 100,
                mp: 40,
                data_from_django: 'TEXT_TEXT_TEXT',


            },
            methods: {

                come_to_tawern() {

                    let ws = new WebSocket('ws://127.0.0.1:8000/ws/chat/');

                    ws.onopen = () => {
                        console.log("Добро пожаловать в таверну!");
                        this.show_tawern = (this.show_tawern !== false) ? false : true;
                        console.log("Соединение установлено.");
                    };

                    ws.onmessage = (data) => {
                        console.log("data равна - " + data);
                    };

                    axios
                        .get('http://127.0.0.1:8000/murr_game/api/return_character_info/')
                        .then(django_answer => {
                            this.avatar_url = django_answer.data.avatar_url;
                            this.murren_name = django_answer.data.character.name;
                            this.hp = django_answer.data.character.stats.hp;
                            this.mp = django_answer.data.character.stats.mp;
                            console.log('axios отработал')
                        })
                        .catch(error => console.log(error));

                },

                create_group_by_name() {
                    {# инициализируем сокет по юрл #}
                    const ws = new WebSocket('ws://127.0.0.1:8000/ws/chat/');

                    {# создаем нужный запрос для бекенда #}
                    let create_group_json = '{"event": "group.create", "data": {"name": "' +
                        this.group_name_input +
                        '"}}';

                    {# при открытии сокета мы сразу отправляем сообщение на бекенд #}
                    ws.onopen = function () {
                        console.log("На бекенд отправлена щадача: " + create_group_json);
                        ws.send(create_group_json);
                    };

                    {# задача обрабатывается на бекенда#}

                    {# пришел ответ от бекенда: #}
                    ws.onmessage = function (data) {
                        console.log('Вот что пришло с бекенда:' + data);
                        data = JSON.parse(event.data);
                        console.log("Остортированные данные" + event.data);
                        console.log("event: " + data.event);
                    };

                    this.success_group_created = true;
                    console.log("РЕЗУЛЬТАТ: " + this.success_group_created);
                    this.logs.push('Группа успешно создана!)');


                },

                show_create_group_panel() {

                    this.show_create_group = (this.show_create_group !== false) ? false : true;
                    console.log('Открылась панель на ввод имени группы');

                },
            },
            computed:
                {
                    show_create_group_menu() {
                        return this.show_create_group
                    }
                }
        });

    </script>

{% endblock js %}

